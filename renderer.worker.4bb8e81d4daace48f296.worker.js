(()=>{"use strict";var e={766:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.chunk=t.shuffle=void 0,t.shuffle=function(e){const t=e;for(let e=t.length-1;e>0;e--){const r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t},t.chunk=function(e,t){const r=[];for(let o=0;o<Math.ceil(e.length/t);o++)r.push(e.slice(t*o,t*o+t));return r}},469:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Color=void 0;const o=r(629),n={};for(let e=0;e<256;e++)n[e]=e.toString(16),1===n[e].length&&(n[e]="0"+n[e]);class s{constructor(e,t,r){this.red=e,this.green=t,this.blue=r,e>255?this.red=255:e<0&&(this.red=0),t>255?this.green=255:t<0&&(this.green=0),r>255?this.blue=255:r<0&&(this.blue=0)}getRed(){return this.red}getGreen(){return this.green}getBlue(){return this.blue}mix(e,t){return new s(Math.round(this.red*(1-t)+e.getRed()*t),Math.round(this.green*(1-t)+e.getGreen()*t),Math.round(this.blue*(1-t)+e.getBlue()*t))}toHexFormat(){return"#"+n[this.red]+n[this.green]+n[this.blue]}equals(e){return this.blue===e.getBlue()&&this.red===e.getRed()&&this.green===e.getGreen()}toArray(){return[this.red,this.green,this.blue]}static random(){return new s((0,o.randomInt)(0,255),(0,o.randomInt)(0,255),(0,o.randomInt)(0,255))}static fromHex(e){return e.startsWith("#")&&(e=e.slice(1)),new s(parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16))}}t.Color=s},629:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.randomInt=void 0,t.randomInt=function(e,t){const r=t-e+1;return Math.floor(Math.random()*r)+e}},120:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Colors=void 0;const o=r(469);t.Colors={organic:o.Color.fromHex("#F0E9D2"),wall:o.Color.fromHex("#575757"),organism:o.Color.fromHex("#2155CD"),lifetimeMin:o.Color.fromHex("#000000"),lifetimeMax:o.Color.fromHex("#ffffff"),energyMin:o.Color.fromHex("#000000"),energyMax:o.Color.fromHex("#F8CB2E"),aggressionMin:o.Color.fromHex("#000000"),aggressionMax:o.Color.fromHex("#ff0000"),childrenMin:o.Color.fromHex("#000000"),childrenMax:o.Color.fromHex("#f542c8"),stepMin:o.Color.fromHex("#000000"),stepMax:o.Color.fromHex("#f57b42"),actions:[o.Color.fromHex("#ffffff"),o.Color.fromHex("#03fcc2"),o.Color.fromHex("#03cafc"),o.Color.fromHex("#aaf200"),o.Color.fromHex("#a705f7"),o.Color.fromHex("#ff0000"),o.Color.fromHex("#ff00f2"),o.Color.fromHex("#ffffff"),o.Color.fromHex("#00ff00"),o.Color.fromHex("#0000ff")],supplyOrganic:o.Color.fromHex("#ff0000"),supplyPhotosynthesis:o.Color.fromHex("#00ff00"),supplyChemosynthesis:o.Color.fromHex("#0000ff")}},415:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CommonRenderer=void 0;const o=r(469),n=r(841),s=r(120),i=(e,t)=>s.Colors.lifetimeMax.mix(s.Colors.lifetimeMin,e/t),a=(e,t,r)=>new o.Color(e,t,r);t.CommonRenderer=class{render(e,t,r,l,u,g,h,c){this.empty&&this.empty.width===t&&this.empty.height===r||this.createEmpty(t,r);const m=new ImageData(new Uint8ClampedArray(this.empty.data),t,r),d=(e,r,o)=>{const n=[];let s=g,i=g;e<0&&(s+=e,e=0),r<0&&(i+=r,r=0),e+g>=m.width&&(s=m.width-e),r+g>=m.height&&(i=m.height-r);for(let e=0;e<s;e++)n.push(o.getRed(),o.getGreen(),o.getBlue(),255);const a=4*e,l=4*t;for(let e=0;e<i;e++)m.data.set(n,l*(r+e)+a)},f=c.getArray();let C=0,p=0;if("lifetime"===h||"energy"===h)for(let e=0;e<c.getWidth();e++)for(let e=0;e<c.getHeight();e++)1===f[p]&&C<f[p+1]&&(C=f[p+1]),p+=c.getItemLength(f[p]);p=0;for(let e=0;e<c.getWidth();e++)for(let t=0;t<c.getHeight();t++){const r=l+e*g;if(r+g<0||r>=m.width){p+=c.getItemLength(f[p]);continue}const T=u+t*g;if(T+g<0||T>=m.height)p+=c.getItemLength(f[p]);else{switch(f[p]){case n.CellType.EMPTY:break;case n.CellType.ORGANISM:d(r,T,"energy"===h?(I=f[p+1],R=C,s.Colors.energyMin.mix(s.Colors.energyMax,I/R)):"lifetime"===h?i(f[p+1],C):"genesis"===h?(O=f[p+1],y=f[p+2],E=f[p+3],new o.Color(O,y,E)):"supply"===h?a(f[p+1],f[p+2],f[p+3]):s.Colors.organism);break;case n.CellType.ORGANIC:d(r,T,s.Colors.organic);break;case n.CellType.WALL:d(r,T,s.Colors.wall)}p+=c.getItemLength(f[p])}}var O,y,E,I,R;e(m)}createEmpty(e,t){this.empty=new ImageData(new Uint8ClampedArray(e*t*4).map(((e,t)=>t%4==3?255:0)),e,t)}}},40:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.AbstractCell=t.CellType=void 0,(r=t.CellType||(t.CellType={}))[r.EMPTY=0]="EMPTY",r[r.ORGANISM=1]="ORGANISM",r[r.ORGANIC=2]="ORGANIC",r[r.WALL=3]="WALL",t.AbstractCell=class{isStatic(){return!0}isEmpty(){return!1}getId(){return 0}}},730:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OrganismCell=t.createPrimitiveProgram=t.Organ=t.GENOME_VERSION=t.ORGANS_COUNT=t.MAX_ENERGY=void 0;const o=r(469),n=r(40),s=r(890),i=r(766),a=r(69),l=r(629);var u;t.MAX_ENERGY=255,t.ORGANS_COUNT=16,t.GENOME_VERSION=2,function(e){e[e.NONE=0]="NONE",e[e.CHLOROPLAST=1]="CHLOROPLAST",e[e.OXIDIZER=2]="OXIDIZER",e[e.EYE=3]="EYE",e[e.REPRODUCTOR=4]="REPRODUCTOR",e[e.FERMENTER=5]="FERMENTER",e[e.MOUTH=6]="MOUTH",e[e.ARMOUR=7]="ARMOUR",e[e.FIN=8]="FIN",e[e.SPINE=9]="SPINE"}(u=t.Organ||(t.Organ={})),t.createPrimitiveProgram=function(e){const t=[a.Command.SENSE,55,3,a.Command.ACTION,16,0,a.Command.GOTO,0,4,a.Command.ACTION,64,0,a.Command.SENSE,2,6,a.Command.GOTO,0,0,a.Command.ACTION,128,0];for(let r=t.length/3;r<e;r++)t.push(a.Command.NOTHING,0,0);return new Uint8Array(t)};const g=[u.NONE,u.CHLOROPLAST,u.OXIDIZER,u.REPRODUCTOR,u.EYE,u.FERMENTER],h=[u.NONE,u.MOUTH,u.ARMOUR,u.FIN,u.SPINE];class c extends n.AbstractCell{constructor(e,t,r,o,n,s,i,a=0){super(),this.id=e,this.organs=t,this.color=r,this.program=o,this.energy=n,this.direction=s,this.supplyColor=i,this.lifetime=a,this.programCounter=0,this.oxidizersCount=0,this.chloroplastsCount=0,this.mouthsCount=0,this.fermentersCount=0,this.instructionsCount=o.length/3;for(const e of t)switch(e){case u.CHLOROPLAST:this.chloroplastsCount++;break;case u.OXIDIZER:this.oxidizersCount++;break;case u.FERMENTER:this.fermentersCount++;break;case u.MOUTH:this.mouthsCount++}}getId(){return this.id}getType(){return n.CellType.ORGANISM}getLifetime(){return this.lifetime}getEnergy(){return this.energy}getDirection(){return this.direction}update(e){this.energy>0&&(e.getInterpreter().execute(this,e),this.changeEnergy(-e.getSimulationParameters().stepCost)),0!==this.energy?this.lifetime>=e.getSimulationParameters().organismMaxLifetime?e.replace(e.getCellFactory().createOrganic(this.energy)):this.lifetime++:e.replace(e.getCellFactory().createEmpty())}setDirection(e){this.direction=e}divide(e){if(0===this.energy)return;const t=e.getCellFactory(),r=e.getSimulationParameters(),n=e.getInterpreter();let u=null;for(const t of(0,i.shuffle)(s.directionsList))if(e.getByDirection(t).isEmpty()){u=t;break}if(null===u)return void e.replace(t.createOrganic(this.energy));this.changeEnergy(Math.floor(this.energy/-2));let c=!1,m=this.color,d=this.organs,f=this.program;const C=(0,l.randomInt)(1,100);if(r.mutationBaseOrgansRate>=C&&(c=!0,d=d.slice(),d[(0,l.randomInt)(0,7)]=g[(0,l.randomInt)(0,g.length-1)]),r.mutationLimbOrgansRate>=C&&(c=!0,d=d.slice(),d[(0,l.randomInt)(8,15)]=h[(0,l.randomInt)(0,h.length-1)]),r.mutationProgramRate>=C){c=!0,f=new Uint8Array(f);const e=3*(0,l.randomInt)(0,this.instructionsCount-1),t=e+1,r=e+2;let o=n.getHandler(f[e]);switch((0,l.randomInt)(0,2)){case 0:f[e]=(0,l.randomInt)(0,n.getHandlersCount()-1),o=n.getHandler(f[e]),o.hasArgument()?0===f[t]&&(f[t]=(0,l.randomInt)(0,a.MAX_ARG_VALUE)):f[t]=0,o.hasGoto()?0===f[r]&&(f[r]=(0,l.randomInt)(0,this.instructionsCount-1)):f[r]=0;break;case 1:o.hasArgument()&&(f[t]=(0,l.randomInt)(0,a.MAX_ARG_VALUE));break;case 2:o.hasGoto()&&(f[r]=(0,l.randomInt)(0,this.instructionsCount-1))}}c&&(m=new o.Color(this.color.getRed()+(Math.random()>.5?1:-1)*(0,l.randomInt)(0,5),this.color.getGreen()+(Math.random()>.5?1:-1)*(0,l.randomInt)(0,5),this.color.getBlue()+(Math.random()>.5?1:-1)*(0,l.randomInt)(0,5))),e.replaceByDirection(u,t.createOrganism(d,m,f,this.energy,(0,s.randomDirection)(),this.supplyColor))}changeEnergy(e){const r=this.energy;return this.energy+=Math.round(e),this.energy>t.MAX_ENERGY?this.energy=t.MAX_ENERGY:this.energy<0&&(this.energy=0),this.energy-r}isStatic(){return!1}getColor(){return this.color}getProgramCounter(){return this.programCounter}setProgramCounter(e){this.instructionsCount>e?this.programCounter=e:this.programCounter=0}addProgramCounterRelative(e){this.setProgramCounter(this.programCounter+e)}getSupplyColor(){return this.supplyColor}getOrgan(e){return this.organs[e]}getChloroplastsCount(){return this.chloroplastsCount}getOxidizersCount(){return this.oxidizersCount}getMouthsCount(){return this.mouthsCount}getFermentersCount(){return this.fermentersCount}makeMoreRed(e){this.supplyColor=new o.Color(this.supplyColor.getRed()+e,this.supplyColor.getGreen()-e,this.supplyColor.getBlue()-e)}makeMoreGreen(e){this.supplyColor=new o.Color(this.supplyColor.getRed()-e,this.supplyColor.getGreen()+e,this.supplyColor.getBlue()-e)}makeMoreBlue(e){this.supplyColor=new o.Color(this.supplyColor.getRed()-e,this.supplyColor.getGreen()-e,this.supplyColor.getBlue()+e)}getOrgans(){return this.organs}getProgram(){return this.program}getCommand(){return this.program[3*this.programCounter]}getArgument(){return this.program[3*this.programCounter+1]}getGoto(){return this.program[3*this.programCounter+2]}isSimilar(e){let t=0;const r=e.getOrgans();for(let e=0;e<16;e++)if(this.organs[e]!==r[e]&&t++,t>1)return!1;const o=e.getProgram(),n=this.program;if(o.length!==n.length)return!1;for(let e=0;e<o.length;e++){if(t>1)return!1;o[e]!==n[e]&&t++}return t<=1}serialize(){const e=[];for(const t of this.program)e.push(t);return{id:this.id,type:n.CellType.ORGANISM,lifetime:this.lifetime,energy:this.energy,direction:this.direction,genome:{organs:this.organs,color:this.color.toHexFormat(),program:e,version:t.GENOME_VERSION},programCounter:this.programCounter,supplyColor:this.supplyColor.toHexFormat()}}}t.OrganismCell=c},138:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AbstractInstruction=void 0,t.AbstractInstruction=class{}},890:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.reverseDirection=t.rotateOnOffset=t.rotateRight=t.rotateLeft=t.randomDirection=t.directionsList=t.Direction=void 0;const o=r(629);var n;function s(e,t){let r=e+t;return r<0&&(r-=8*Math.floor(r/8)),r%8}!function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(n=t.Direction||(t.Direction={})),t.directionsList=[n.NORTH,n.NORTH_EAST,n.EAST,n.SOUTH_EAST,n.SOUTH,n.SOUTH_WEST,n.WEST,n.NORTH_WEST],t.randomDirection=function(){return(0,o.randomInt)(0,7)},t.rotateLeft=function(e){return e===n.NORTH?n.NORTH_WEST:e-1},t.rotateRight=function(e){return e===n.NORTH_WEST?n.NORTH:e+1},t.rotateOnOffset=s,t.reverseDirection=function(e){return s(e,4)}},458:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ActionInstruction=t.DIVIDER=void 0;const o=r(138);t.DIVIDER=16;class n extends o.AbstractInstruction{execute(e,r,o){const n=Math.trunc(o/t.DIVIDER),s=o-n*t.DIVIDER,i=r.getOrganPool().getOrgan(e.getOrgan(n));if(!i)return e.addProgramCounterRelative(1),!1;const a=i.use(e,s,r,n);return e.addProgramCounterRelative(1),a}hasArgument(){return!0}hasGoto(){return!1}}t.ActionInstruction=n},754:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GotoInstruction=void 0;const o=r(138);class n extends o.AbstractInstruction{execute(e,t,r,o){return e.setProgramCounter(o),!1}hasArgument(){return!1}hasGoto(){return!0}}t.GotoInstruction=n},496:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NothingInstruction=void 0;const o=r(138);class n extends o.AbstractInstruction{execute(e){return e.addProgramCounterRelative(1),!1}hasArgument(){return!1}hasGoto(){return!1}}t.NothingInstruction=n},987:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SenseInstruction=t.DIVIDER=void 0;const o=r(138);t.DIVIDER=16;class n extends o.AbstractInstruction{execute(e,r,o,n){const s=Math.trunc(o/t.DIVIDER),i=o-s*t.DIVIDER,a=r.getOrganPool().getOrgan(e.getOrgan(s));return a?(a.sense(e,i,r,s)?e.setProgramCounter(n):e.addProgramCounterRelative(1),!1):(e.addProgramCounterRelative(1),!1)}hasArgument(){return!0}hasGoto(){return!0}}t.SenseInstruction=n},69:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Interpreter=t.MAX_ARG_VALUE=t.Command=void 0;const o=r(458),n=r(987),s=r(754),i=r(496);var a;!function(e){e[e.NOTHING=0]="NOTHING",e[e.GOTO=1]="GOTO",e[e.SENSE=2]="SENSE",e[e.ACTION=3]="ACTION"}(a=t.Command||(t.Command={})),t.MAX_ARG_VALUE=255;const l={[a.NOTHING]:new i.NothingInstruction,[a.GOTO]:new s.GotoInstruction,[a.SENSE]:new n.SenseInstruction,[a.ACTION]:new o.ActionInstruction},u=Object.keys(l).length;t.Interpreter=class{execute(e,t){for(let r=0;r<16&&!l[e.getCommand()].execute(e,t,e.getArgument(),e.getGoto());r++);}getHandlersCount(){return u}getHandler(e){return l[e]}}},158:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Data=void 0;const o=r(730),n=r(841),s={energy:1,lifetime:1,genesis:3,supply:3};class i{constructor(e,t,r,o){this.array=e,this.payload=t,this.width=r,this.height=o,this.organismDataLength=this.payload?s[this.payload]+1:1}static create(e,t){const r=e.getWidth(),n=e.getHeight(),s=[];for(let i=0;i<r;i++)for(let r=0;r<n;r++){const n=e.getCell(i,r);if(s.push(n.getType()),n instanceof o.OrganismCell)switch(t){case"energy":s.push(n.getEnergy());break;case"lifetime":s.push(n.getLifetime());break;case"genesis":s.push(n.getColor().getRed()),s.push(n.getColor().getGreen()),s.push(n.getColor().getBlue());break;case"supply":s.push(n.getSupplyColor().getRed()),s.push(n.getSupplyColor().getGreen()),s.push(n.getSupplyColor().getBlue())}}return new i(new Uint8Array(s),t,r,n)}getArray(){return this.array}getPayload(){return this.payload}getWidth(){return this.width}getHeight(){return this.height}getItemLength(e){switch(e){case n.CellType.EMPTY:return 1;case n.CellType.ORGANISM:return this.organismDataLength;case n.CellType.ORGANIC:case n.CellType.WALL:return 1}throw new Error}}t.Data=i},841:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GENOME_VERSION=t.Command=t.Direction=t.Organ=t.CellType=void 0;const o=r(730);Object.defineProperty(t,"Organ",{enumerable:!0,get:function(){return o.Organ}}),Object.defineProperty(t,"GENOME_VERSION",{enumerable:!0,get:function(){return o.GENOME_VERSION}});const n=r(890);Object.defineProperty(t,"Direction",{enumerable:!0,get:function(){return n.Direction}});const s=r(69);Object.defineProperty(t,"Command",{enumerable:!0,get:function(){return s.Command}});const i=r(40);Object.defineProperty(t,"CellType",{enumerable:!0,get:function(){return i.CellType}})}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,r),s.exports}(()=>{const e=r(158),t=r(415),o=self,n=new t.CommonRenderer,s=[];setTimeout((function t(){if(s.length){const t=s.shift(),r=new e.Data(t.data.array,t.data.payload,t.data.width,t.data.height);n.render((e=>{o.postMessage({id:t.id,data:e},[e.data.buffer])}),t.width,t.height,t.offsetX,t.offsetY,t.scale,t.mode,r)}setTimeout(t,0)}),0),o.addEventListener("message",(e=>{s.push(e.data)}))})()})();