(()=>{"use strict";var e={766:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.shuffle=void 0,t.shuffle=function(e){const t=e;for(let e=t.length-1;e>0;e--){const r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}},904:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AssertLessOrEqualThanError=t.AssertLessThanError=t.AssertGreaterOrEqualThanError=t.AssertGreaterThanError=t.AssertIntegerError=t.AssertError=t.assertLessOrEqualThan=t.assertLessThan=t.assertGreaterOrEqualThan=t.assertGreaterThan=t.assertInteger=void 0,t.assertInteger=function(e){if(!Number.isInteger(e))throw new s},t.assertGreaterThan=function(e,t){if(e<=t)throw new i},t.assertGreaterOrEqualThan=function(e,t){if(e<t)throw new n},t.assertLessThan=function(e,t){if(e>=t)throw new a},t.assertLessOrEqualThan=function(e,t){if(e>t)throw new o};class r extends Error{}t.AssertError=r;class s extends r{}t.AssertIntegerError=s;class i extends r{}t.AssertGreaterThanError=i;class n extends r{}t.AssertGreaterOrEqualThanError=n;class a extends r{}t.AssertLessThanError=a;class o extends r{}t.AssertLessOrEqualThanError=o},469:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Color=void 0;const s=r(904),i=r(629);class n{constructor(e,t,r){this.red=e,this.green=t,this.blue=r,(0,s.assertGreaterOrEqualThan)(e,0),(0,s.assertGreaterOrEqualThan)(t,0),(0,s.assertGreaterOrEqualThan)(r,0),(0,s.assertLessOrEqualThan)(e,255),(0,s.assertLessOrEqualThan)(t,255),(0,s.assertLessOrEqualThan)(r,255);const i=e=>1===e.length?"0"+e:e;this.hex="#"+i(this.red.toString(16))+i(this.green.toString(16))+i(this.blue.toString(16))}getRed(){return this.red}getGreen(){return this.green}getBlue(){return this.blue}mix(e,t){return new n(Math.round(this.red*t+e.getRed()*(1-t)),Math.round(this.green*t+e.getGreen()*(1-t)),Math.round(this.blue*t+e.getBlue()*(1-t)))}toHexFormat(){return this.hex}equals(e){return this.blue===e.getBlue()&&this.red===e.getRed()&&this.green===e.getGreen()}toArray(){return[this.red,this.green,this.blue]}static random(){return new n((0,i.randomInt)(0,255),(0,i.randomInt)(0,255),(0,i.randomInt)(0,255))}static fromHex(e){return e.startsWith("#")&&(e=e.slice(1)),new n(parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16))}}t.Color=n},629:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.randomInt=void 0,t.randomInt=function(e,t){const r=t-e+1;return Math.floor(Math.random()*r)+e}},40:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AbstractCell=void 0,t.AbstractCell=class{update(e,t){}isStatic(){return!0}isEmpty(){return!1}}},591:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CellContext=void 0;const s=r(282);class i extends Error{}t.CellContext=class{constructor(e,t,r,s){this.grid=e,this.x=t,this.y=r,this.factory=s}moveByOffest(e,t){try{const r=this.getCoordinatesbyOffset(e,t),s=this.grid.getCell(this.x,this.y);this.grid.getCell(r[0],r[1]).isEmpty()&&(this.grid.delete(this.x,this.y),this.grid.insert(r[0],r[1],s))}catch(e){}}deleteByOffset(e,t){const r=this.getCoordinatesbyOffset(e,t);this.grid.delete(r[0],r[1])}getByOffest(e,t){try{const r=this.getCoordinatesbyOffset(e,t);return this.grid.getCell(r[0],r[1])}catch(e){return this.factory.createWall()}}replace(e){this.grid.delete(this.x,this.y),this.grid.insert(this.x,this.y,e(this.factory))}getCoordinatesbyOffset(e,t){const r=this.grid.getLoopMode(),n=r===s.GridLoopType.TORUS||r===s.GridLoopType.HORIZONTAL,a=r===s.GridLoopType.TORUS||r===s.GridLoopType.VERTICAL,o=this.grid.getWidth(),l=this.grid.getHeight();let h=this.x+e,c=this.y+t;if(n)for(;h<0;)h+=o;else if(h<0||h>o-1)throw new i;if(a)for(;c<0;)c+=l;else if(c<0||c>l-1)throw new i;return[h%o,c%l]}}},240:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CellFactory=void 0;const s=r(816),i=r(347),n=r(730),a=r(59);t.CellFactory=class{createWall(){return this.wall?this.wall:this.wall=new a.WallCell}createEmpty(){return this.empty?this.empty:this.empty=new s.EmptyCell}createOrganism(e,t,r){return new n.OrganismCell(e,t,r)}createOrganic(){return this.organic?this.organic:this.organic=new i.OrganicCell}}},816:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EmptyCell=void 0;const s=r(40);class i extends s.AbstractCell{getType(){return"empty"}isEmpty(){return!0}serialize(){return{type:"empty"}}}t.EmptyCell=i},347:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OrganicCell=void 0;const s=r(40);class i extends s.AbstractCell{getType(){return"organic"}serialize(){return{type:"organic"}}}t.OrganicCell=i},730:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OrganismCell=void 0;const s=r(40),i=r(890),n=r(347),a=r(48);class o extends s.AbstractCell{constructor(e,t,r){super(),this.color=e,this.genome=t,this.energy=r,this.lifetime=0,this.direction=(0,i.randomDirection)()}getType(){return"organism"}getLifetime(){return this.lifetime}getEnergy(){return this.energy}getDirection(){return this.direction}getGenome(){return this.genome}update(e,t){if(0!==t.organismMaxLifetime&&this.lifetime>t.organismMaxLifetime||this.energy<=0)return void e.replace((e=>e.createOrganic()));const r=(0,i.getOffset)(this.direction),s=e.getByOffest(r[0],r[1]),n=this.genome.getAction(this,s);n===a.OrganismAction.STEP?this.makeStep(e):n===a.OrganismAction.ROTATE_LEFT?this.rotateLeft():n===a.OrganismAction.ROTATE_RIGHT?this.rotateRight():n===a.OrganismAction.DIVIDE?this.divide(e):n===a.OrganismAction.ATTACK?this.attact(e):n===a.OrganismAction.EAT?this.eat(e,t):n===a.OrganismAction.PHOTOSYNTHESIS&&this.photosynthesis(t.photosynthesisEnergy),this.lifetime++}rotateLeft(){this.direction=(0,i.rotateLeft)(this.direction),this.changeEnergy(-1)}rotateRight(){this.direction=(0,i.rotateRight)(this.direction),this.changeEnergy(-1)}makeStep(e){const t=(0,i.getOffset)(this.direction);e.moveByOffest(t[0],t[1]),this.changeEnergy(-1)}divide(e){for(const t in i.Direction){const r=(0,i.getOffset)(i.Direction[t]);if(e.getByOffest(r[0],r[1]).isEmpty())return e.moveByOffest(r[0],r[1]),this.changeEnergy(Math.floor(this.energy/-2)),void e.replace((e=>e.createOrganism(this.color,this.genome.clone(),this.energy)))}}attact(e){const t=(0,i.getOffset)(this.direction),r=e.getByOffest(t[0],t[1]);r instanceof o&&(r.getEnergy()<=this.getEnergy()&&r.changeEnergy(this.getEnergy()/-3),this.changeEnergy(-1))}eat(e,t){const r=(0,i.getOffset)(this.direction);e.getByOffest(r[0],r[1])instanceof n.OrganicCell&&(e.deleteByOffset(r[0],r[1]),e.moveByOffest(r[0],r[1]),this.changeEnergy(t.organicEnergy))}photosynthesis(e){this.changeEnergy(e)}changeEnergy(e){this.energy+=e,this.energy>100?this.energy=100:this.energy<0&&(this.energy=0)}kill(){this.energy=0}isStatic(){return!1}isSimilar(e){return this.color.equals(e.getColor())}getColor(){return this.color}serialize(){return{type:"organism",lifetime:this.lifetime,energy:this.energy,color:this.color.toHexFormat(),direction:this.direction.toString()}}}t.OrganismCell=o},48:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.randomAction=t.OrganismAction=void 0;const s=r(629);var i;!function(e){e.ROTATE_LEFT="ROTATE_LEFT",e.ROTATE_RIGHT="ROTATE_RIGHT",e.STEP="STEP",e.ATTACK="ATTACK",e.EAT="EAT",e.DIVIDE="DIVIDE",e.NOTHING="NOTHING",e.PHOTOSYNTHESIS="PHOTOSYNTHESIS"}(i=t.OrganismAction||(t.OrganismAction={})),t.randomAction=function(){const e=Object.keys(i);return i[e[(0,s.randomInt)(0,e.length-1)]]}},890:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.rotateRight=t.rotateLeft=t.randomDirection=t.getOffset=t.Direction=void 0;const s=r(629);var i;!function(e){e.NORTH="NORTH",e.NORTH_EAST="NORTH_EAST",e.NORTH_WEST="NORTH_WEST",e.SOUTH="SOUTH",e.SOUTH_EAST="SOUTH_EAST",e.SOUTH_WEST="SOUTH_WEST",e.EAST="EAST",e.WEST="WEST"}(i=t.Direction||(t.Direction={})),t.getOffset=function(e){switch(e){case i.NORTH:return[0,-1];case i.NORTH_EAST:return[1,-1];case i.NORTH_WEST:return[-1,-1];case i.SOUTH:return[0,1];case i.SOUTH_EAST:return[1,1];case i.SOUTH_WEST:return[-1,1];case i.EAST:return[1,0];case i.WEST:return[-1,0]}},t.randomDirection=function(){return i[Object.keys(i)[(0,s.randomInt)(0,7)]]},t.rotateLeft=function(e){switch(e){case i.NORTH:return i.NORTH_WEST;case i.NORTH_EAST:return i.NORTH;case i.NORTH_WEST:return i.WEST;case i.SOUTH:return i.SOUTH_EAST;case i.SOUTH_EAST:return i.EAST;case i.SOUTH_WEST:return i.SOUTH;case i.EAST:return i.NORTH_EAST;case i.WEST:return i.SOUTH_WEST}},t.rotateRight=function(e){switch(e){case i.NORTH:return i.NORTH_EAST;case i.NORTH_EAST:return i.EAST;case i.NORTH_WEST:return i.NORTH;case i.SOUTH:return i.SOUTH_WEST;case i.SOUTH_EAST:return i.SOUTH;case i.SOUTH_WEST:return i.WEST;case i.EAST:return i.SOUTH_EAST;case i.WEST:return i.NORTH_WEST}}},165:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Genome=void 0;const s=r(347),i=r(48),n=r(730),a=r(59),o=r(629);var l;!function(e){e.EMPTY="EMPTY",e.WALL="WALL",e.ORGANIC="ORGANIC",e.ORGANISM_SIMILAR="ORGANISM_SIMILAR",e.ORGANISM_OTHER="ORGANISM_OTHER"}(l||(l={}));class h{constructor(e,t,r={}){this.mutationСhance=e,this.similarityLimit=t,this.reflexes=r}getAction(e,t){const r=e.getEnergy()>60;let o;if(o=t instanceof a.WallCell?l.WALL:t instanceof s.OrganicCell?l.ORGANIC:t instanceof n.OrganismCell?e.isSimilar(t)?l.ORGANISM_SIMILAR:l.ORGANISM_OTHER:l.EMPTY,r&&o===l.EMPTY)return i.OrganismAction.DIVIDE;const h=this.reflexes[`${o}`];return void 0===h||h===i.OrganismAction.DIVIDE&&!r?i.OrganismAction.NOTHING:h}compare(e){return 0}isSimilar(e){return this.compare(e)>=this.similarityLimit}clone(){let e=this.similarityLimit,t=this.mutationСhance,r={};for(let e of Object.keys(l))r[e]=this.reflexes[e];if(this.mutationСhance>(0,o.randomInt)(0,100)){const s=(0,o.randomInt)(0,7);if(0===s)t+=5*(1===(0,o.randomInt)(0,1)?-1:1);else if(1===s)e+=5*(1===(0,o.randomInt)(0,1)?-1:1);else if(s>=2){const e=Object.keys(l);r[e[(0,o.randomInt)(0,e.length-1)]]=(0,i.randomAction)()}}return new h(t,e,r)}static createRandom(){let e={};for(let t of Object.keys(l))e[t]=(0,i.randomAction)();return new h(Math.floor(100*Math.random()),Math.floor(100*Math.random()),e)}}t.Genome=h},59:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WallCell=void 0;const s=r(40);class i extends s.AbstractCell{getType(){return"wall"}serialize(){return{type:"wall"}}}t.WallCell=i},170:function(e,t,r){var s=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))((function(i,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function o(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,o)}l((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CommonSimulation=void 0;const i=r(766),n=r(469),a=r(240),o=r(165),l=r(158),h=r(567),c=r(56),g=r(691);class u extends h.Simulation{constructor(e){super(e),e=this.options,this.cellFactory=new a.CellFactory,this.state=new g.State(e.width,e.height,e.loop,new c.SimulationParameters,this.cellFactory);const t=Math.ceil(e.width*e.height*e.population/100);this.spawnOrganisms(t,e.initialEnergy)}step(){return new Promise((e=>{this.state.next(),e(this.state.getStep())}))}getState(e){return new Promise((t=>{const r=l.Data.create(this.state,e);t({step:this.state.getStep(),buffer:r.getArray().buffer,payload:e})}))}setParameter(e,t){return s(this,void 0,void 0,(function*(){return this.state.getParameters()[e]=t,this.state.getParameters()[e]}))}getOrganismsCount(){return s(this,void 0,void 0,(function*(){return this.state.getOrganismsCount()}))}spawnOrganisms(e,t){const r=[],s=this.state.getGrid().toArray();for(let e=0;e<s.length;e++)for(let t=0;t<s[e].length;t++)s[e][t].isEmpty()&&r.push([e,t]);for(const[s,a]of(0,i.shuffle)(r).slice(0,e))this.state.getGrid().insert(s,a,this.cellFactory.createOrganism(n.Color.random(),o.Genome.createRandom(),t))}}t.CommonSimulation=u},158:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Data=void 0;const s=r(730),i={empty:0,organism:1,organic:2,wall:3},n={direction:1,energy:1,lifetime:1,genesis:3},a={NORTH:0,NORTH_EAST:1,NORTH_WEST:2,SOUTH:3,SOUTH_EAST:4,SOUTH_WEST:5,EAST:6,WEST:7};class o{constructor(e,t,r,s){this.array=e,this.payload=t,this.width=r,this.height=s,this.itemLength=this.payload?n[this.payload]+1:1}static create(e,t){const r=e.getGrid(),l=r.getWidth(),h=r.getHeight(),c=t?n[t]:0,g=new Uint8Array(l*h*(c+1));let u=0;for(let e=0;e<l;e++)for(let n=0;n<h;n++){const o=r.getCell(e,n);if(g[u++]=i[o.getType()],o instanceof s.OrganismCell)switch(t){case"direction":g[u]=a[o.getDirection()];break;case"energy":g[u]=o.getEnergy();break;case"lifetime":g[u]=o.getLifetime();break;case"genesis":const e=o.getColor().toArray();g[u]=e[0],g[u+1]=e[1],g[u+2]=e[2]}u+=c}return new o(g,t,l,h)}getArray(){return this.array}getPayload(){return this.payload}getWidth(){return this.width}getHeight(){return this.height}getItemLength(){return this.itemLength}}t.Data=o},928:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Grid=void 0;const s=r(904);t.Grid=class{constructor(e,t,r,i){this.width=e,this.height=t,this.loop=r,this.cellFactory=i,this.cells=[],(0,s.assertGreaterThan)(e,0),(0,s.assertGreaterThan)(t,0);for(let r=0;r<e;r++){this.cells[r]=[];for(let e=0;e<t;e++)this.cells[r][e]=i.createEmpty()}}insert(e,t,r){(0,s.assertLessThan)(e,this.width),(0,s.assertLessThan)(t,this.height),(0,s.assertGreaterOrEqualThan)(e,0),(0,s.assertGreaterOrEqualThan)(t,0),this.cells[e][t]=r}delete(e,t){this.cells[e][t]=this.cellFactory.createEmpty()}getCell(e,t){return this.cells[e][t]}getLoopMode(){return this.loop}getWidth(){return this.width}getHeight(){return this.height}toArray(){return this.cells.map((e=>e.slice()))}serialize(){return this.toArray().map((e=>e.map((e=>e.serialize()))))}}},56:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SimulationParameters=void 0,t.SimulationParameters=class{constructor(e={}){this.organismMaxLifetimeValue=255,this.photosynthesisEnergyValue=1,this.organicEnergyValue=20,null!=e.photosynthesisEnergy&&(this.photosynthesisEnergy=e.photosynthesisEnergy),null!=e.organismMaxLifetime&&(this.organismMaxLifetime=e.organismMaxLifetime),null!=e.organicEnergy&&(this.organicEnergy=e.organicEnergy)}set organismMaxLifetime(e){this.organismMaxLifetimeValue=this.converNumberValue(e,!0,1,255)}get organismMaxLifetime(){return this.organismMaxLifetimeValue}set photosynthesisEnergy(e){this.photosynthesisEnergyValue=this.converNumberValue(e,!1,0,255)}get photosynthesisEnergy(){return this.photosynthesisEnergyValue}set organicEnergy(e){this.organicEnergyValue=this.converNumberValue(e,!1,0,255)}get organicEnergy(){return this.organicEnergyValue}serialize(){return{photosynthesisEnergy:this.photosynthesisEnergy,organismMaxLifetime:this.organismMaxLifetime,organicEnergy:this.organicEnergy}}converNumberValue(e,t=!0,r=null,s=null){return t&&(e=Math.trunc(e)),null==r&&(e=Math.max(r,e)),null==s&&(e=Math.min(s,e)),e}}},567:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Simulation=t.StepData=void 0,t.StepData=class{constructor(e,t,r){this.step=e,this.buffer=t,this.payload=r}},t.Simulation=class{constructor(e){this.options=e}terminate(){}getOptions(){return this.options}}},691:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.State=void 0;const s=r(591),i=r(928);t.State=class{constructor(e,t,r,s,n){this.parameters=s,this.cellFactory=n,this.step=0,this.grid=new i.Grid(e,t,r,n)}next(){const e=this.grid.toArray();for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length;r++){const i=e[t][r];i.isStatic()||i.update(new s.CellContext(this.grid,t,r,this.cellFactory),this.parameters)}this.step++}getGrid(){return this.grid}getStep(){return this.step}getParameters(){return this.parameters}getOrganismsCount(){let e=0;for(let t=0;t<this.grid.getWidth();t++)for(let r=0;r<this.grid.getHeight();r++)"organism"===this.grid.getCell(t,r).getType()&&e++;return e}}},282:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.GridLoopType=void 0,(r=t.GridLoopType||(t.GridLoopType={})).NONE="NONE",r.TORUS="TORUS",r.VERTICAL="VERTICAL",r.HORIZONTAL="HORIZONTAL"}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,r),n.exports}(()=>{const e=r(170),t=self;let s;const i={init:r=>{s||(s=new e.CommonSimulation(r.options),t.postMessage({type:"init"}))},step:e=>{s.step().then((r=>{t.postMessage({type:"step",step:r,id:e.id})}))},requestState:e=>{s.getState(e.payload).then((r=>{t.postMessage({id:e.id,type:"state",step:r.step,buffer:r.buffer,payload:r.payload},[r.buffer])}))},setParameter:e=>{s.setParameter(e.parameter,e.value).then((r=>{t.postMessage({id:e.id,type:"setParameter",value:r})}))},getOrganismsCount:e=>{s.getOrganismsCount().then((r=>{t.postMessage({id:e.id,type:"getOrganismsCount",count:r})}))}};t.addEventListener("message",(e=>{i[e.data.type](e.data)}))})()})();