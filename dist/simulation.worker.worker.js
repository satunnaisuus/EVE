(()=>{"use strict";var t={766:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.shuffle=void 0,e.shuffle=function(t){const e=t;for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}},904:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.AssertLessOrEqualThanError=e.AssertLessThanError=e.AssertGreaterOrEqualThanError=e.AssertGreaterThanError=e.AssertIntegerError=e.AssertError=e.assertLessOrEqualThan=e.assertLessThan=e.assertGreaterOrEqualThan=e.assertGreaterThan=e.assertInteger=void 0,e.assertInteger=function(t){if(!Number.isInteger(t))throw new s},e.assertGreaterThan=function(t,e){if(t<=e)throw new i},e.assertGreaterOrEqualThan=function(t,e){if(t<e)throw new n},e.assertLessThan=function(t,e){if(t>=e)throw new a},e.assertLessOrEqualThan=function(t,e){if(t>e)throw new o};class r extends Error{}e.AssertError=r;class s extends r{}e.AssertIntegerError=s;class i extends r{}e.AssertGreaterThanError=i;class n extends r{}e.AssertGreaterOrEqualThanError=n;class a extends r{}e.AssertLessThanError=a;class o extends r{}e.AssertLessOrEqualThanError=o},469:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Color=void 0;const s=r(904),i=r(629);class n{constructor(t,e,r){this.red=t,this.green=e,this.blue=r,(0,s.assertGreaterOrEqualThan)(t,0),(0,s.assertGreaterOrEqualThan)(e,0),(0,s.assertGreaterOrEqualThan)(r,0),(0,s.assertLessOrEqualThan)(t,255),(0,s.assertLessOrEqualThan)(e,255),(0,s.assertLessOrEqualThan)(r,255);const i=t=>1===t.length?"0"+t:t;this.hex="#"+i(this.red.toString(16))+i(this.green.toString(16))+i(this.blue.toString(16))}getRed(){return this.red}getGreen(){return this.green}getBlue(){return this.blue}mix(t,e){return new n(Math.round(this.red*e+t.getRed()*(1-e)),Math.round(this.green*e+t.getGreen()*(1-e)),Math.round(this.blue*e+t.getBlue()*(1-e)))}toHexFormat(){return this.hex}equals(t){return this.blue===t.getBlue()&&this.red===t.getRed()&&this.green===t.getGreen()}toArray(){return[this.red,this.green,this.blue]}static random(){return new n((0,i.randomInt)(0,255),(0,i.randomInt)(0,255),(0,i.randomInt)(0,255))}static fromHex(t){return t.startsWith("#")&&(t=t.slice(1)),new n(parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16))}}e.Color=n},629:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.randomInt=void 0,e.randomInt=function(t,e){const r=e-t+1;return Math.floor(Math.random()*r)+t}},40:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.AbstractCell=void 0,e.AbstractCell=class{update(t,e){}isStatic(){return!0}isEmpty(){return!1}}},591:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.CellContext=void 0;const s=r(282);class i extends Error{}e.CellContext=class{constructor(t,e,r,s){this.grid=t,this.x=e,this.y=r,this.factory=s}moveByOffest(t,e){try{const r=this.getCoordinatesbyOffset(t,e),s=this.grid.getCell(this.x,this.y);this.grid.getCell(r[0],r[1]).isEmpty()&&(this.grid.delete(this.x,this.y),this.grid.insert(r[0],r[1],s))}catch(t){}}deleteByOffset(t,e){const r=this.getCoordinatesbyOffset(t,e);this.grid.delete(r[0],r[1])}getByOffest(t,e){try{const r=this.getCoordinatesbyOffset(t,e);return this.grid.getCell(r[0],r[1])}catch(t){return this.factory.createWall()}}replace(t){this.grid.delete(this.x,this.y),this.grid.insert(this.x,this.y,t(this.factory))}getCoordinatesbyOffset(t,e){const r=this.grid.getLoopMode(),n=r===s.GridLoopType.TORUS||r===s.GridLoopType.HORIZONTAL,a=r===s.GridLoopType.TORUS||r===s.GridLoopType.VERTICAL,o=this.grid.getWidth(),h=this.grid.getHeight();let l=this.x+t,c=this.y+e;if(n)for(;l<0;)l+=o;else if(l<0||l>o-1)throw new i;if(a)for(;c<0;)c+=h;else if(c<0||c>h-1)throw new i;return[l%o,c%h]}}},240:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.CellFactory=void 0;const s=r(816),i=r(347),n=r(730),a=r(59);e.CellFactory=class{createWall(){return this.wall?this.wall:this.wall=new a.WallCell}createEmpty(){return this.empty?this.empty:this.empty=new s.EmptyCell}createOrganism(t,e,r){return new n.OrganismCell(t,e,r)}createOrganic(){return this.organic?this.organic:this.organic=new i.OrganicCell}}},17:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.CellVisitor=void 0,e.CellVisitor=class{visitEmpty(t){}visitWall(t){}visitOrganism(t){}visitOrganic(t){}}},816:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EmptyCell=void 0;const s=r(40);class i extends s.AbstractCell{getType(){return"empty"}visit(t){t.visitEmpty(this)}isEmpty(){return!0}serialize(){return{type:"empty"}}}e.EmptyCell=i},347:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.OrganicCell=void 0;const s=r(40);class i extends s.AbstractCell{getType(){return"organic"}visit(t){t.visitOrganic(this)}serialize(){return{type:"organic"}}}e.OrganicCell=i},730:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.OrganismCell=void 0;const s=r(40),i=r(17),n=r(890),a=r(48);class o extends s.AbstractCell{constructor(t,e,r){super(),this.color=t,this.genome=e,this.energy=r,this.lifetime=0,this.direction=(0,n.randomDirection)()}getType(){return"organism"}getLifetime(){return this.lifetime}getEnergy(){return this.energy}getDirection(){return this.direction}getGenome(){return this.genome}visit(t){t.visitOrganism(this)}update(t,e){if(0!==e.getOrganismMaxLifetime()&&this.lifetime>e.getOrganismMaxLifetime()||this.energy<=0)return void t.replace((t=>t.createOrganic()));const r=(0,n.getOffset)(this.direction),s=t.getByOffest(r[0],r[1]),i=this.genome.getAction(this,s);i===a.OrganismAction.STEP?this.makeStep(t):i===a.OrganismAction.ROTATE_LEFT?this.rotateLeft():i===a.OrganismAction.ROTATE_RIGHT?this.rotateRight():i===a.OrganismAction.DIVIDE?this.divide(t):i===a.OrganismAction.ATTACK?this.attact(t):i===a.OrganismAction.EAT?this.eat(t,e):i===a.OrganismAction.PHOTOSYNTHESIS&&this.photosynthesis(e.getPhotosynthesisEnergy()),this.lifetime++}rotateLeft(){this.direction=(0,n.rotateLeft)(this.direction),this.changeEnergy(-1)}rotateRight(){this.direction=(0,n.rotateRight)(this.direction),this.changeEnergy(-1)}makeStep(t){const e=(0,n.getOffset)(this.direction);t.moveByOffest(e[0],e[1]),this.changeEnergy(-1)}divide(t){for(const e in n.Direction){const r=(0,n.getOffset)(n.Direction[e]);if(t.getByOffest(r[0],r[1]).isEmpty())return t.moveByOffest(r[0],r[1]),this.changeEnergy(Math.floor(this.energy/-2)),void t.replace((t=>t.createOrganism(this.color,this.genome.clone(),this.energy)))}}attact(t){const e=(0,n.getOffset)(this.direction),r=t.getByOffest(e[0],e[1]),s=this;r.visit(new class extends i.CellVisitor{visitOrganism(t){t.getEnergy()<=s.getEnergy()&&t.changeEnergy(s.getEnergy()/-3),s.changeEnergy(-1)}})}eat(t,e){const r=(0,n.getOffset)(this.direction),s=t.getByOffest(r[0],r[1]),a=this;s.visit(new class extends i.CellVisitor{visitOrganic(s){t.deleteByOffset(r[0],r[1]),t.moveByOffest(r[0],r[1]),a.changeEnergy(e.getOrganicEnergy())}})}photosynthesis(t){this.changeEnergy(t)}changeEnergy(t){this.energy+=t,this.energy>100?this.energy=100:this.energy<0&&(this.energy=0)}kill(){this.energy=0}isStatic(){return!1}isSimilar(t){return this.color.equals(t.getColor())}getColor(){return this.color}serialize(){return{type:"organism",lifetime:this.lifetime,energy:this.energy,color:this.color.toHexFormat(),direction:this.direction.toString()}}}e.OrganismCell=o},48:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.randomAction=e.OrganismAction=void 0;const s=r(629);var i;!function(t){t.ROTATE_LEFT="ROTATE_LEFT",t.ROTATE_RIGHT="ROTATE_RIGHT",t.STEP="STEP",t.ATTACK="ATTACK",t.EAT="EAT",t.DIVIDE="DIVIDE",t.NOTHING="NOTHING",t.PHOTOSYNTHESIS="PHOTOSYNTHESIS"}(i=e.OrganismAction||(e.OrganismAction={})),e.randomAction=function(){const t=Object.keys(i);return i[t[(0,s.randomInt)(0,t.length-1)]]}},890:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.rotateRight=e.rotateLeft=e.randomDirection=e.getOffset=e.Direction=void 0;const s=r(629);var i;!function(t){t.NORTH="NORTH",t.NORTH_EAST="NORTH_EAST",t.NORTH_WEST="NORTH_WEST",t.SOUTH="SOUTH",t.SOUTH_EAST="SOUTH_EAST",t.SOUTH_WEST="SOUTH_WEST",t.EAST="EAST",t.WEST="WEST"}(i=e.Direction||(e.Direction={})),e.getOffset=function(t){switch(t){case i.NORTH:return[0,-1];case i.NORTH_EAST:return[1,-1];case i.NORTH_WEST:return[-1,-1];case i.SOUTH:return[0,1];case i.SOUTH_EAST:return[1,1];case i.SOUTH_WEST:return[-1,1];case i.EAST:return[1,0];case i.WEST:return[-1,0]}},e.randomDirection=function(){return i[Object.keys(i)[(0,s.randomInt)(0,7)]]},e.rotateLeft=function(t){switch(t){case i.NORTH:return i.NORTH_WEST;case i.NORTH_EAST:return i.NORTH;case i.NORTH_WEST:return i.WEST;case i.SOUTH:return i.SOUTH_EAST;case i.SOUTH_EAST:return i.EAST;case i.SOUTH_WEST:return i.SOUTH;case i.EAST:return i.NORTH_EAST;case i.WEST:return i.SOUTH_WEST}},e.rotateRight=function(t){switch(t){case i.NORTH:return i.NORTH_EAST;case i.NORTH_EAST:return i.EAST;case i.NORTH_WEST:return i.NORTH;case i.SOUTH:return i.SOUTH_WEST;case i.SOUTH_EAST:return i.SOUTH;case i.SOUTH_WEST:return i.WEST;case i.EAST:return i.SOUTH_EAST;case i.WEST:return i.NORTH_WEST}}},165:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Genome=void 0;const s=r(48),i=r(629);var n;!function(t){t.EMPTY="EMPTY",t.WALL="WALL",t.ORGANIC="ORGANIC",t.ORGANISM_SIMILAR="ORGANISM_SIMILAR",t.ORGANISM_OTHER="ORGANISM_OTHER"}(n||(n={}));class a{constructor(t,e,r={}){this.mutationСhance=t,this.similarityLimit=e,this.reflexes=r}getAction(t,e){const r=t.getEnergy()>60;let i;if(e.visit({visitEmpty:t=>{i=n.EMPTY},visitWall:t=>{i=n.WALL},visitOrganic:t=>{i=n.ORGANIC},visitOrganism:e=>{i=t.isSimilar(e)?n.ORGANISM_SIMILAR:n.ORGANISM_OTHER}}),r&&i===n.EMPTY)return s.OrganismAction.DIVIDE;const a=this.reflexes[`${i}`];return void 0===a||a===s.OrganismAction.DIVIDE&&!r?s.OrganismAction.NOTHING:a}compare(t){return 0}isSimilar(t){return this.compare(t)>=this.similarityLimit}clone(){let t=this.similarityLimit,e=this.mutationСhance,r={};for(let t of Object.keys(n))r[t]=this.reflexes[t];if(this.mutationСhance>(0,i.randomInt)(0,100)){const a=(0,i.randomInt)(0,7);if(0===a)e+=5*(1===(0,i.randomInt)(0,1)?-1:1);else if(1===a)t+=5*(1===(0,i.randomInt)(0,1)?-1:1);else if(a>=2){const t=Object.keys(n);r[t[(0,i.randomInt)(0,t.length-1)]]=(0,s.randomAction)()}}return new a(e,t,r)}static createRandom(){let t={};for(let e of Object.keys(n))t[e]=(0,s.randomAction)();return new a(Math.floor(100*Math.random()),Math.floor(100*Math.random()),t)}}e.Genome=a},59:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.WallCell=void 0;const s=r(40);class i extends s.AbstractCell{getType(){return"wall"}visit(t){t.visitWall(this)}serialize(){return{type:"wall"}}}e.WallCell=i},170:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.CommonSimulation=void 0;const s=r(766),i=r(469),n=r(240),a=r(165),o=r(158),h=r(567),l=r(231),c=r(691);class g extends h.Simulation{constructor(t){super(t),t=this.options,this.cellFactory=new n.CellFactory,this.state=new c.State(t.width,t.height,t.loop,new l.SimulationParams,this.cellFactory);const e=Math.ceil(t.width*t.height*t.population/100);this.spawnOrganisms(e,t.initialEnergy)}step(){return new Promise((t=>{this.state.next(),t(this.state.getStep())}))}getState(t){return new Promise((e=>{const r=o.Data.create(this.state,t);e({step:this.state.getStep(),buffer:r.getArray().buffer,payload:t})}))}spawnOrganisms(t,e){const r=[],n=this.state.getGrid().toArray();for(let t=0;t<n.length;t++)for(let e=0;e<n[t].length;e++)n[t][e].isEmpty()&&r.push([t,e]);for(const[n,o]of(0,s.shuffle)(r).slice(0,t))this.state.getGrid().insert(n,o,this.cellFactory.createOrganism(i.Color.random(),a.Genome.createRandom(),e))}}e.CommonSimulation=g},158:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Data=void 0;const r={empty:0,organism:1,organic:2,wall:3},s={NORTH:0,NORTH_EAST:1,NORTH_WEST:2,SOUTH:3,SOUTH_EAST:4,SOUTH_WEST:5,EAST:6,WEST:7};class i{constructor(t,e,r,s){this.array=t,this.payload=e,this.width=r,this.height=s}static create(t,e){const n=t.getGrid(),a=n.getWidth(),o=n.getHeight(),h=new Uint8Array(a*o*(e.length+1));let l=0;for(let t=0;t<a;t++)for(let i=0;i<o;i++){const a=n.getCell(t,i);h[l]=r[a.getType()],a.visit({visitEmpty:()=>{l+=e.length+1},visitOrganic:()=>{l+=e.length+1},visitWall:()=>{l+=e.length+1},visitOrganism:t=>{for(const r of e)switch(r){case"direction":h[++l]=s[t.getDirection()];break;case"energy":h[++l]=t.getEnergy();break;case"lifetime":h[++l]=t.getLifetime();break;default:throw new Error}l++}})}return new i(h,e,a,o)}getArray(){return this.array}getPayload(){return this.payload}getWidth(){return this.width}getHeight(){return this.height}}e.Data=i},928:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Grid=void 0;const s=r(904);e.Grid=class{constructor(t,e,r,i){this.width=t,this.height=e,this.loop=r,this.cellFactory=i,this.cells=[],(0,s.assertGreaterThan)(t,0),(0,s.assertGreaterThan)(e,0);for(let r=0;r<t;r++){this.cells[r]=[];for(let t=0;t<e;t++)this.cells[r][t]=i.createEmpty()}}insert(t,e,r){(0,s.assertLessThan)(t,this.width),(0,s.assertLessThan)(e,this.height),(0,s.assertGreaterOrEqualThan)(t,0),(0,s.assertGreaterOrEqualThan)(e,0),this.cells[t][e]=r}delete(t,e){this.cells[t][e]=this.cellFactory.createEmpty()}getCell(t,e){return this.cells[t][e]}getLoopMode(){return this.loop}getWidth(){return this.width}getHeight(){return this.height}toArray(){return this.cells.map((t=>t.slice()))}serialize(){return this.toArray().map((t=>t.map((t=>t.serialize()))))}}},231:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SimulationParams=void 0,e.SimulationParams=class{constructor(t={}){this.organismMaxLifetime=100,this.photosynthesisEnergy=2,this.organicEnergy=20;const e=e=>null!==t[e]&&void 0!==t[e];e("photosynthesisEnergy")&&this.setPhotosynthesisEnergy(t.photosynthesisEnergy),e("organismMaxLifetime")&&this.setOrganismMaxLifetime(t.organismMaxLifetime),e("organicEnergy")&&this.setOrganicEnergy(t.organicEnergy)}getOrganicEnergy(){return this.organicEnergy}setOrganicEnergy(t){this.organicEnergy=t}getOrganismMaxLifetime(){return this.organismMaxLifetime}setOrganismMaxLifetime(t){this.organismMaxLifetime=t}getPhotosynthesisEnergy(){return this.photosynthesisEnergy}setPhotosynthesisEnergy(t){this.photosynthesisEnergy=t}serialize(){return{photosynthesisEnergy:this.photosynthesisEnergy,organismMaxLifetime:this.organismMaxLifetime,organicEnergy:this.organicEnergy}}}},567:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Simulation=e.StepData=void 0;const s=r(282);e.StepData=class{constructor(t,e,r){this.step=t,this.buffer=e,this.payload=r}},e.Simulation=class{constructor(t){this.options=Object.assign({width:200,height:100,loop:s.GridLoopType.NONE,population:5,initialEnergy:70},t)}terminate(){}getOptions(){return this.options}}},691:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.State=void 0;const s=r(591),i=r(928);e.State=class{constructor(t,e,r,s,n){this.params=s,this.cellFactory=n,this.step=0,this.grid=new i.Grid(t,e,r,n)}next(){const t=this.grid.toArray();for(let e=0;e<t.length;e++)for(let r=0;r<t[e].length;r++){const i=t[e][r];i.isStatic()||i.update(new s.CellContext(this.grid,e,r,this.cellFactory),this.params)}this.step++}getGrid(){return this.grid}getStep(){return this.step}getParams(){return this.params}setParams(t){this.params=t}}},282:(t,e)=>{var r;Object.defineProperty(e,"__esModule",{value:!0}),e.GridLoopType=void 0,(r=e.GridLoopType||(e.GridLoopType={})).NONE="NONE",r.TORUS="TORUS",r.VERTICAL="VERTICAL",r.HORIZONTAL="HORIZONTAL"}},e={};function r(s){var i=e[s];if(void 0!==i)return i.exports;var n=e[s]={exports:{}};return t[s](n,n.exports,r),n.exports}(()=>{const t=r(170),e=self;let s;e.addEventListener("message",(r=>{switch(r.data.type){case"init":return i=r.data,void(s||(s=new t.CommonSimulation(i.options),e.postMessage({type:"init"})));case"step":return(t=>{s.step().then((r=>{e.postMessage({type:"step",step:r,id:t.id})}))})(r.data);case"requestState":return(t=>{s.getState(t.payload).then((r=>{e.postMessage({id:t.id,type:"state",step:r.step,buffer:r.buffer,payload:r.payload},[r.buffer])}))})(r.data)}var i}))})()})();